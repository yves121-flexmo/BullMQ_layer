# BullMQ System - Architecture Organis√©e

Ce projet fournit une **architecture compl√®te et organis√©e** au-dessus de BullMQ pour cr√©er des syst√®mes asynchrones robustes et scalables. L'architecture s√©pare clairement les composants core BullMQ des logiques m√©tier sp√©cialis√©es, avec un syst√®me de logs globaux ind√©pendant.

## üéØ Objectif

Cr√©er une architecture BullMQ claire et logiquement organis√©e :
- **S√©paration des responsabilit√©s** : Core / Managers / Services / Utils
- **Logs globaux ind√©pendants** du m√©tier (jobs, queues, statuts, performances)
- **Composants core r√©utilisables** pour tout type de projet
- **Managers m√©tier sp√©cialis√©s** (emails, exports, etc.)
- **Persistance MongoDB** avec Mongoose pour logs et m√©triques
- **Gestion intelligente** des environnements (dev/production)

## üèóÔ∏è Architecture

### üìÅ Architecture Organis√©e par Responsabilit√©

```
bullMQ_examples/
‚îú‚îÄ‚îÄ core/                    # üîß BullMQ pur (r√©utilisable)
‚îÇ   ‚îú‚îÄ‚îÄ BullMQManager.js    # Interface centrale BullMQ
‚îÇ   ‚îú‚îÄ‚îÄ QueueManager.js     # Gestion queues
‚îÇ   ‚îú‚îÄ‚îÄ WorkerManager.js    # Gestion workers
‚îÇ   ‚îú‚îÄ‚îÄ EventManager.js     # Syst√®me d'√©v√©nements
‚îÇ   ‚îî‚îÄ‚îÄ FlowManager.js      # Workflows complexes
‚îú‚îÄ‚îÄ managers/               # üè¢ Managers m√©tier sp√©cialis√©s
‚îÇ   ‚îî‚îÄ‚îÄ MailManager.js      # Sp√©cialis√© emails
‚îú‚îÄ‚îÄ services/               # üöÄ Services applicatifs
‚îÇ   ‚îî‚îÄ‚îÄ RemboursementMailService.js  # Service remboursements
‚îú‚îÄ‚îÄ utils/                  # üõ†Ô∏è Utilitaires transversaux
‚îÇ   ‚îú‚îÄ‚îÄ JobLogger.js        # Logs globaux + MongoDB
‚îÇ   ‚îî‚îÄ‚îÄ models/             # Mod√®les Mongoose
‚îÇ       ‚îú‚îÄ‚îÄ JobLog.js       # Sch√©ma logs jobs
‚îÇ       ‚îî‚îÄ‚îÄ index.js        # Export mod√®les
‚îî‚îÄ‚îÄ examples/               # üìö Exemples
    ‚îî‚îÄ‚îÄ new-architecture-usage.js  # D√©mo architecture
```

### üîß Composants par Couche

#### üèóÔ∏è **Core BullMQ** (R√©utilisable universellement)
- **BullMQManager** : Interface centrale BullMQ pure, sans logique m√©tier
- **QueueManager** : Gestion queues + schedulers int√©gr√©s (BullMQ v5+)
- **WorkerManager** : Workers + routing de jobs g√©n√©riques
- **EventManager** : Syst√®me d'√©v√©nements global
- **FlowManager** : Workflows complexes avec d√©pendances

#### üè¢ **Managers M√©tier** (Sp√©cialis√©s par domaine)
- **MailManager** : H√©rite de BullMQManager, sp√©cialis√© emails
  - Envoi d'emails (welcome, reset, newsletter, custom)
  - Templates et personnalisation
  - Workflows email avec validation
  - Handlers sp√©cialis√©s (validate-email, prepare-template, etc.)

#### üöÄ **Services Applicatifs** (Logique business)
- **RemboursementMailService** : Syst√®me rappels de remboursements
  - Cron jobs automatiques (Corporate/Coverage)
  - Logique m√©tier complexe
  - Injection de d√©pendances

#### üõ†Ô∏è **Utils Transversaux** (Ind√©pendants du m√©tier)
- **JobLogger** : Logs globaux tous jobs/queues avec Mongoose
  - M√©triques temps d'ex√©cution, statuts, erreurs
  - Persistance MongoDB automatique
  - Statistiques et analyse de performance
- **Models** : Sch√©mas Mongoose pour persistance

## üöÄ Installation

```bash
# D√©pendances principales
npm install bullmq ioredis mongoose dotenv

# Pour les exemples et monitoring
npm install express @bull-board/api @bull-board/express

# S'assurer que Redis et MongoDB sont install√©s
brew install redis mongodb-community
brew services start redis
brew services start mongodb-community
```

### Variables d'Environnement

```bash
# .env
REDIS_URL=redis://localhost:6379
MONGO_URI=mongodb://localhost:27017/bullmq_logs
NODE_ENV=development  # ou production
```

## üí° Utilisation

### Exemple Core BullMQ (Universel)

```javascript
const { BullMQManager, JobLogger } = require('./index');

async function basicUsage() {
  // 1. BullMQManager - Core pur (utilisable pour tout type de jobs)
  const bullMQ = new BullMQManager({
    redis: { url: process.env.REDIS_URL || 'redis://localhost:6379' },
    isProduction: process.env.NODE_ENV === 'production'
  });

  // 2. JobLogger - Logs globaux ind√©pendants du m√©tier
  const jobLogger = new JobLogger({
    mongo: { uri: process.env.MONGO_URI },
    isProduction: process.env.NODE_ENV === 'production'
  });

  await bullMQ.initialize();

  // 3. Cr√©ation queue + workers g√©n√©riques
  bullMQ.createQueue('data-processing');
  
  const handlers = {
    'process-csv': async (data, job) => {
      console.log(`üìä Traitement ${data.filename}`);
      await new Promise(resolve => setTimeout(resolve, 1000));
      return { success: true, rowsProcessed: 1500 };
    },
    'generate-report': async (data, job) => {
      console.log(`üìã G√©n√©ration ${data.type}`);
      await new Promise(resolve => setTimeout(resolve, 800));
      return { success: true, reportId: 'RPT-001' };
    }
  };

  bullMQ.startWorker('data-processing', handlers);

  // 4. Attachment des logs globaux
  jobLogger.attachToBullMQManager(bullMQ);

  // 5. Ajout de jobs
  await bullMQ.addJob('data-processing', 'process-csv', { filename: 'users.csv' });
  await bullMQ.addJob('data-processing', 'generate-report', { type: 'monthly' });

  // 6. Monitoring des m√©triques globales
  setTimeout(async () => {
    const stats = jobLogger.getDetailedStats();
    console.log(`üìä ${stats.global.totalJobs} jobs, ${stats.global.successRate} succ√®s`);
  }, 3000);

  // Nettoyage
  await bullMQ.shutdown();
}
```

### Exemple Manager M√©tier (Emails)

```javascript
const { MailManager } = require('./index');

async function emailUsage() {
  // MailManager - Sp√©cialis√© pour les emails
  const mailManager = new MailManager({
    redis: { url: process.env.REDIS_URL },
    isProduction: process.env.NODE_ENV === 'production',
    emailService: {
      sendEmail: async (emailData) => {
        console.log(`üìß Envoi √†: ${emailData.to.join(', ')}`);
        return { messageId: `MSG-${Date.now()}` };
      }
    },
    emailConfig: {
      templates: MailManager.createSampleTemplates()
    }
  });

  await mailManager.initialize();

  // Envois d'emails via interface m√©tier
  await mailManager.sendWelcomeEmail('user@example.com', { name: 'Alice' });
  await mailManager.sendPasswordResetEmail('user@example.com', 'token123');
  
  // Newsletter en lot
  const recipients = [
    { email: 'user1@example.com', name: 'User 1' },
    { email: 'user2@example.com', name: 'User 2' }
  ];
  
  await mailManager.sendNewsletter(recipients, {
    subject: 'Newsletter Janvier',
    campaignId: 'NL-2024-01'
  });

  // Workflow email avec validation
  const emailFlow = await mailManager.createEmailFlow({
    id: 'email-001',
    to: 'test@example.com',
    subject: 'Test Workflow'
  });

  console.log('Workflow email cr√©√©:', emailFlow.id);
  
  await mailManager.shutdown();
}
```

## üìä Composants BullMQ Natifs vs Couche d'Abstraction

### üîç **BullMQ Natif** - Les 5 Composants Fondamentaux

BullMQ fournit 5 classes principales que vous devez g√©rer manuellement :

#### 1. **Queue** - Stockage des Jobs
```javascript
// BullMQ Natif
const { Queue } = require('bullmq');
const emailQueue = new Queue('emails', { connection: { host: 'localhost', port: 6379 } });

// Ajout de jobs
await emailQueue.add('send-welcome', { to: 'user@example.com' });
```
**Probl√®me** : Vous devez g√©rer manuellement la connexion Redis, la configuration, et chaque queue s√©par√©ment.

#### 2. **QueueScheduler** - Gestion des Jobs Diff√©r√©s/R√©currents ‚ö†Ô∏è OBSOL√àTE
```javascript
// BullMQ Ancien - QueueScheduler s√©par√© (ne plus utiliser)
const { QueueScheduler } = require('bullmq');
const scheduler = new QueueScheduler('emails', { connection: { host: 'localhost', port: 6379 } });

// ‚ùå OBSOL√àTE dans les versions r√©centes de BullMQ
```
**Probl√®me r√©solu** : QueueScheduler supprim√© dans BullMQ v5+, fonctionnalit√© int√©gr√©e dans Queue.

#### 3. **Worker** - Traitement des Jobs
```javascript
// BullMQ Natif
const { Worker } = require('bullmq');
const worker = new Worker('emails', async (job) => {
  if (job.name === 'send-welcome') {
    // Logique d'envoi
  } else if (job.name === 'send-newsletter') {
    // Autre logique
  }
  // Gestion manuelle de tous les types de jobs
}, { connection: { host: 'localhost', port: 6379 } });
```
**Probl√®me** : Code r√©p√©titif, gestion manuelle du routing des jobs.

#### 4. **QueueEvents** - Monitoring
```javascript
// BullMQ Natif
const { QueueEvents } = require('bullmq');
const events = new QueueEvents('emails', { connection: { host: 'localhost', port: 6379 } });

events.on('completed', ({ jobId }) => console.log(`Job ${jobId} termin√©`));
events.on('failed', ({ jobId }) => console.log(`Job ${jobId} √©chou√©`));
```
**Probl√®me** : Configuration r√©p√©titive pour chaque queue, pas de monitoring global.

#### 5. **FlowProducer** - Workflows Complexes
```javascript
// BullMQ Natif
const { FlowProducer } = require('bullmq');
const flow = new FlowProducer({ connection: { host: 'localhost', port: 6379 } });

// Configuration manuelle complexe
await flow.add({
  name: 'email-workflow',
  queueName: 'emails',
  data: {},
  children: [/* Configuration manuelle de chaque √©tape */]
});
```
**Probl√®me** : Configuration verbose, pas de patterns pr√©-d√©finis.

### üöÄ **Notre Couche d'Abstraction** - Tout Unifi√©

| Composant BullMQ | Probl√®me Natif | Notre Solution | Avantage |
|------------------|----------------|----------------|----------|
| **Queue** | Gestion manuelle s√©par√©e | `QueueManager` | ‚úÖ Cr√©ation centralis√©e, configuration partag√©e |
| **QueueScheduler** | Obsol√®te (int√©gr√©) | `QueueManager` | ‚úÖ **Fonctionnalit√© int√©gr√©e** dans Queue |
| **Worker** | Routing manuel des jobs | `WorkerManager` | ‚úÖ Handlers automatiques, routing intelligent |
| **QueueEvents** | Config r√©p√©titive | `EventManager` | ‚úÖ Listeners globaux + sp√©cifiques, monitoring unifi√© |
| **FlowProducer** | Configuration verbose | `FlowManager` | ‚úÖ Patterns pr√©-d√©finis, workflows simplifi√©s |

### üìã **Comparaison Concr√®te**

#### ‚ùå **BullMQ Natif** (15+ lignes, erreurs fr√©quentes)
```javascript
const { Queue, Worker, QueueEvents } = require('bullmq');

// 1. Configuration r√©p√©titive pour chaque composant
const connection = { host: 'localhost', port: 6379 };
const emailQueue = new Queue('emails', { connection });
// Note: QueueScheduler n'existe plus dans BullMQ v5+ (int√©gr√© dans Queue)
const events = new QueueEvents('emails', { connection });

// 2. Worker avec routing manuel
const worker = new Worker('emails', async (job) => {
  // Gestion manuelle de chaque type de job
  switch(job.name) {
    case 'send-welcome': /* logique */ break;
    case 'send-newsletter': /* logique */ break;
    default: throw new Error('Type de job inconnu');
  }
}, { connection });

// 3. Events s√©par√©s
events.on('completed', (data) => console.log('Job termin√©'));
events.on('failed', (data) => console.log('Job √©chou√©'));

// 4. Pas de nettoyage centralis√©
process.on('SIGTERM', async () => {
  await worker.close();
  await events.close();
  await emailQueue.close();
});
```

#### ‚úÖ **Notre Architecture** (3 lignes, z√©ro erreur)
```javascript
const MailManager = require('./core/MailManager');

// 1. Initialisation unifi√©e
const mailManager = new MailManager({ redis: { host: 'localhost', port: 6379 } });
await mailManager.initialize();

// 2. Cr√©ation queue + scheduler automatique + events
mailManager.createQueue('emails');

// 3. Worker avec handlers pr√©-d√©finis
const handlers = WorkerManager.createEmailHandlers();
mailManager.startWorker('emails', handlers);

// 4. Nettoyage automatique
await mailManager.shutdown(); // Ferme TOUT proprement
```

### üß† **Correspondance 1:1 des Concepts**

```
BullMQ Natif (Complexe)          Notre Couche (Simple)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Queue               ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ QueueManager        ‚îÇ
‚îÇ + Scheduler int√©gr√© ‚îÇ         ‚îÇ (gestion unifi√©e)   ‚îÇ
‚îÇ + Redis Config      ‚îÇ         ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Worker              ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ WorkerManager       ‚îÇ
‚îÇ + Job Routing       ‚îÇ         ‚îÇ (routing auto)      ‚îÇ
‚îÇ + Error Handling    ‚îÇ         ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ QueueEvents         ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ EventManager        ‚îÇ
‚îÇ + Event Listeners   ‚îÇ         ‚îÇ (global + local)    ‚îÇ
‚îÇ + Per-Queue Config  ‚îÇ         ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FlowProducer        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ FlowManager         ‚îÇ
‚îÇ + Manual Config     ‚îÇ         ‚îÇ (patterns ready)    ‚îÇ
‚îÇ + Complex Setup     ‚îÇ         ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         Tout g√©r√© par MailManager (Interface unique)
```

### ‚ùó **Points Critiques BullMQ que Notre Architecture R√©sout**

1. **Scheduler Obsol√®te** ‚ûú **Int√©gr√© dans Queue** (BullMQ v5+)
2. **Configuration Redis R√©p√©t√©e** ‚ûú **Configuration centralis√©e** 
3. **Gestion d'Erreurs Manuelle** ‚ûú **Retry intelligent** int√©gr√©
4. **Monitoring Fragment√©** ‚ûú **Monitoring unifi√©** 
5. **Shutdown Complexe** ‚ûú **Shutdown automatique** de tous les composants

**Notre couche n'invente rien** - elle organise simplement BullMQ de fa√ßon logique et supprime la complexit√© inutile !

## üîÑ Patterns Disponibles

### Jobs simples
```javascript
await mailManager.addJob('emails', 'send-welcome', data);
```

### Jobs planifi√©s (avec scheduler automatique)
```javascript
await mailManager.scheduleJob('emails', 'send-newsletter', data, '0 9 * * *');
```

### Workflows avec d√©pendances
```javascript
await mailManager.addFlow(flowDefinition);
```

### Handlers d'emails pr√©-d√©finis
- `send-welcome` : Email de bienvenue
- `send-newsletter` : Newsletter
- `send-reset-password` : R√©initialisation mot de passe
- `send-notification` : Notifications

### Flows pr√©-d√©finis
- `createEmailFlow()` : Email avec validation
- `createNewsletterFlow()` : Newsletter multi-destinataires  
- `createConditionalFlow()` : Workflow conditionnel
- `createRetryFlow()` : Retry intelligent

## üìà Monitoring et M√©triques

```javascript
// √âtat de sant√© global
const health = await mailManager.healthCheck();

// Statistiques d'une queue
const stats = await mailManager.getQueueStats('emails');

// M√©triques compl√®tes
const allMetrics = await mailManager.queueManager.getAllQueueMetrics();
const flowMetrics = mailManager.flowManager.getFlowMetrics();
const eventStats = mailManager.eventManager.getEventStats();

// Audit log
mailManager.eventManager.setupAuditListeners();
const auditLog = mailManager.eventManager.getAuditLog(100);
```

## üõ†Ô∏è Configuration Avanc√©e

```javascript
const config = {
  redis: {
    host: 'localhost',
    port: 6379,
    // Ou utiliser une URL : url: 'redis://localhost:6379'
  },
  defaultOptions: {
    attempts: 5,
    backoff: { type: 'exponential', delay: 2000 },
    removeOnComplete: 100,
    removeOnFail: 50
  }
};

const mailManager = new MailManager(config);
```

## üîç Handlers Personnalis√©s

```javascript
const customHandlers = {
  'my-custom-job': async (data, job) => {
    console.log(`Traitement custom: ${data.id}`);
    
    // Mise √† jour du progr√®s
    await job.updateProgress(50);
    
    // Logique m√©tier
    const result = await processData(data);
    
    await job.updateProgress(100);
    return result;
  }
};

mailManager.startWorker('my-queue', customHandlers);
```

## üìÅ Structure Finale du Projet

```
bullMQ_examples/
‚îú‚îÄ‚îÄ üîß core/                 # BullMQ pur (r√©utilisable universellement)
‚îÇ   ‚îú‚îÄ‚îÄ BullMQManager.js    # Interface centrale BullMQ
‚îÇ   ‚îú‚îÄ‚îÄ QueueManager.js     # Gestion queues + schedulers
‚îÇ   ‚îú‚îÄ‚îÄ WorkerManager.js    # Gestion workers g√©n√©riques  
‚îÇ   ‚îú‚îÄ‚îÄ EventManager.js     # Syst√®me d'√©v√©nements
‚îÇ   ‚îî‚îÄ‚îÄ FlowManager.js      # Workflows complexes
‚îú‚îÄ‚îÄ üè¢ managers/             # Managers m√©tier sp√©cialis√©s
‚îÇ   ‚îî‚îÄ‚îÄ MailManager.js      # Gestionnaire emails (h√©rite BullMQManager)
‚îú‚îÄ‚îÄ üöÄ services/             # Services applicatifs (logique business)
‚îÇ   ‚îî‚îÄ‚îÄ RemboursementMailService.js  # Service rappels remboursements
‚îú‚îÄ‚îÄ üõ†Ô∏è  utils/               # Utilitaires transversaux
‚îÇ   ‚îú‚îÄ‚îÄ JobLogger.js        # Logs globaux + MongoDB (Mongoose)
‚îÇ   ‚îî‚îÄ‚îÄ models/             # Mod√®les Mongoose
‚îÇ       ‚îú‚îÄ‚îÄ JobLog.js       # Sch√©ma jobs logs
‚îÇ       ‚îî‚îÄ‚îÄ index.js        # Export mod√®les
‚îú‚îÄ‚îÄ üìö examples/             # Exemples et d√©monstrations
‚îÇ   ‚îú‚îÄ‚îÄ new-architecture-usage.js     # D√©mo nouvelle architecture
‚îÇ   ‚îú‚îÄ‚îÄ architecture-complete.js     # Exemple complet organis√©
‚îÇ   ‚îú‚îÄ‚îÄ basic-usage.js               # Exemples basiques
‚îÇ   ‚îî‚îÄ‚îÄ remboursement-service-usage.js # Service remboursements
‚îú‚îÄ‚îÄ index.js                # üö™ Point d'entr√©e principal  
‚îî‚îÄ‚îÄ main.js                 # üñ•Ô∏è Interface Bull Board (monitoring)
```

### üéØ **S√©paration des Responsabilit√©s Finalis√©e**

| Couche | Responsabilit√© | R√©utilisabilit√© | Exemples |
|--------|---------------|-----------------|----------|
| **Core** | BullMQ pur, sans logique m√©tier | ‚úÖ Universelle | Data processing, exports, analytics |
| **Managers** | Logique m√©tier sp√©cialis√©e | ‚úÖ Par domaine | Emails, notifications, rapports |
| **Services** | Applications business complexes | ‚ùå Sp√©cifique | Remboursements, factures, workflows |
| **Utils** | Transversaux ind√©pendants | ‚úÖ Universelle | Logs, m√©triques, monitoring |

## üß™ Tests et Exemples

```bash
# Architecture compl√®te
node examples/new-architecture-usage.js

# Core BullMQ seulement
node examples/new-architecture-usage.js core

# Manager m√©tier email
node examples/new-architecture-usage.js mail

# Service remboursements
node examples/remboursement-service-usage.js

# Interface de monitoring Bull Board
node main.js  # http://localhost:3000
```

### Installation des d√©pendances MongoDB

```bash
# Installation de mongoose (si pas encore fait)
npm install mongoose

# D√©marrage MongoDB local
brew services start mongodb-community

# V√©rification de la connexion
mongo --eval "db.adminCommand('ismaster')"
```

## ‚ö° Performances

- **Concurrence configurable** par worker
- **Nettoyage automatique** des anciens jobs
- **Retry exponentiel** intelligent
- **Monitoring des performances** int√©gr√©
- **Audit log** avec rotation automatique

## üîê Gestion d'Erreurs

- Retries automatiques avec backoff exponentiel
- Monitoring des √©checs r√©currents
- Alertes pour les jobs probl√©matiques
- Isolation des erreurs par queue
- Logs d√©taill√©s pour le debug

## üì¶ Migration depuis BullMQ Classique

```javascript
// Avant (BullMQ classique)
const { Queue, Worker, QueueScheduler } = require('bullmq');
const queue = new Queue('emails');
const scheduler = new QueueScheduler('emails');
const worker = new Worker('emails', processor);

// Apr√®s (Architecture unifi√©e)
const mailManager = new MailManager();
await mailManager.initialize();
mailManager.createQueue('emails');  // Scheduler cr√©√© automatiquement
mailManager.startWorker('emails', handlers);
```

## üè¢ Cas d'Usage Sp√©cialis√© : Syst√®me de Rappels de Remboursements

### Architecture pour Rappels Automatiques

Le projet inclut `RemboursementMailManager`, une sp√©cialisation du MailManager pour g√©rer automatiquement les rappels de remboursements selon vos sp√©cifications :

#### üìÖ **Planification Automatique**

```javascript
const RemboursementMailService = require('./services/RemboursementMailService');

const reminderService = new RemboursementMailService({
  // Configuration avec variables d'environnement
  redis: {
    url: process.env.REDIS_URL || 'redis://localhost:6379'
  },
  mongo: {
    uri: process.env.MONGO_URI // Pour logs en production
  },
  isProduction: process.env.NODE_ENV === 'production',
  
  // Services √† injecter
  reimbursementService: yourReimbursementService,
  managerService: yourManagerService,
  emailService: yourEmailService,
  loggerService: yourLoggerService
});

await reminderService.initialize();
// Le syst√®me fonctionne maintenant automatiquement !
```

#### üè¢ **Corporate (SALARY) - Logique Impl√©ment√©e**
- **Cron** : `0 9 1-10 * *` (Jours 1-10 du mois √† 9h)
- **Types** : Remboursements SALARY avec statut PENDING/OVERDUE
- **Logique** :
  - `dueDate <= aujourd'hui` ‚Üí Email "paiement en retard" 
  - `dueDate > aujourd'hui` ‚Üí Email "rappel avant √©ch√©ance"
- **Destinataires** : Owner + 3 plus vieux managers Corporate

#### üè• **Coverage (TREASURY) - Logique Impl√©ment√©e**
- **Cron** : `0 10 * * *` (Tous les jours √† 10h)
- **Types** : Remboursements TREASURY avec statut PENDING/OVERDUE
- **Organisation** : Group√©s par health-coverage comme demand√©
- **Logique** :
  - `dueDate <= aujourd'hui` ‚Üí Email "paiement en retard"
  - `dueDate <= aujourd'hui + 10 jours` ‚Üí Email "rappel 10 jours avant"
  - Sinon ‚Üí Pas d'email
- **Destinataires** : Owner + 3 plus vieux managers Coverage

#### üîß **Services √† Impl√©menter**

```javascript
const config = {
  redis: { host: 'localhost', port: 6379 },
  reimbursementService: {
    async getReimbursements({ type, statuses }) {
      // Retourner les remboursements selon type (SALARY/TREASURY) et statuts
      return await Reimbursement.find({ 
        type, 
        globalStatus: { $in: statuses } 
      });
    }
  },
  managerService: {
    async getReimbursementOwner(reimbursementId) {
      // Retourner le propri√©taire du remboursement
      return await Manager.findOne({ reimbursementId });
    },
    async getOldestManagers(type, limit = 3) {
      // Retourner les 3 plus vieux managers selon le type
      return await Manager.find({ type })
        .sort({ createdAt: 1 })
        .limit(limit);
    }
  },
  emailService: {
    async sendReminderEmail({ type, recipients, reimbursement, daysInfo, template }) {
      // Envoyer l'email via votre service (SendGrid, Mailgun, etc.)
      return await sendEmail({
        to: recipients.map(r => r.email),
        subject: template.subject,
        template: template.template,
        data: { reimbursement, daysInfo }
      });
    }
  }
};
```

#### üìä **Monitoring et Contr√¥le**

```javascript
// Statistiques en temps r√©el
const stats = await reminderManager.getReminderStats();

// Ex√©cution forc√©e pour tests
await reminderManager.forceReminderExecution('corporate'); // ou 'coverage' ou 'both'

// Monitoring des erreurs
reminderManager.onEvent('corporate-reminders', 'failed', (data) => {
  console.error('Erreur Corporate:', data.failedReason);
  // Alerter les administrateurs
});
```

#### üß™ **Test du Syst√®me**

```bash
# Test d√©veloppement avec logs
node examples/remboursement-service-usage.js

# Test production (logs r√©duits + MongoDB)
node examples/remboursement-service-usage.js production

# Test avec variables d'environnement
node examples/remboursement-service-usage.js env

# Guide d'int√©gration
node examples/remboursement-service-usage.js integration
```

## üöÄ Int√©gration dans une Application Existante

### üîß **Int√©gration Core BullMQ**
1. **Copier le dossier `core/`** dans votre projet
2. **Installer les d√©pendances** : `npm install bullmq ioredis`
3. **Utiliser MailManager** pour vos besoins BullMQ g√©n√©riques

### üè¢ **Int√©gration Services M√©tier**
1. **Copier `core/` + `services/`** dans votre projet
2. **Configurer les variables d'environnement** :
   ```bash
   REDIS_URL=redis://user:pass@host:port
   MONGO_URI=mongodb://host:port/database  # Optionnel
   NODE_ENV=production  # Pour logs r√©duits
   ```
3. **Utiliser RemboursementMailService** avec vos services inject√©s
4. **Le syst√®me fonctionne automatiquement** avec les cron jobs !

## üìã API R√©f√©rence

### MailManager

```javascript
// Initialisation
await mailManager.initialize()
await mailManager.shutdown()

// Queues
mailManager.createQueue(name, options)
await mailManager.addJob(queueName, jobName, data, options)
await mailManager.scheduleJob(queueName, jobName, data, cronPattern, options)

// Workers
mailManager.startWorker(queueName, handlers, options)

// Flows
await mailManager.addFlow(flowDefinition)

// Events
mailManager.onEvent(queueName, eventType, callback)

// Monitoring
await mailManager.getQueueStats(queueName)
await mailManager.healthCheck()
```

## üìÑ Licence

ISC

---

## üéâ Synth√®se Finale

### ‚úÖ **Ce qui a √©t√© R√©alis√©**

1. **üèóÔ∏è Architecture Organis√©e** : S√©paration claire Core/Managers/Services/Utils
2. **üîß Core BullMQ Pur** : Interface universelle r√©utilisable pour tout projet
3. **üè¢ Managers M√©tier** : Sp√©cialis√©s par domaine (emails, exports, etc.)
4. **üöÄ Services Applicatifs** : Logique business complexe avec injection de d√©pendances
5. **üõ†Ô∏è Utils Transversaux** : Logs globaux ind√©pendants du m√©tier avec MongoDB
6. **üìä Persistance MongoDB** : Mongoose pour logs, m√©triques et analyse de performance
7. **üåç Gestion Environnements** : Configuration automatique dev/production
8. **üìö Documentation Compl√®te** : Exemples et guides d'int√©gration

### üöÄ **Utilisation Recommand√©e**

```javascript
// 1. Core BullMQ (pour tout type de jobs)
const { BullMQManager, JobLogger } = require('./index');

// 2. Manager M√©tier (pour emails sp√©cifiquement)  
const { MailManager } = require('./index');

// 3. Service Applicatif (pour logique business)
const { RemboursementMailService } = require('./index');
```

### üéØ **Avantages de Cette Architecture**

- ‚úÖ **S√©paration claire** des responsabilit√©s m√©tier
- ‚úÖ **R√©utilisabilit√©** des composants core dans tout projet
- ‚úÖ **Logs globaux** ind√©pendants du type de jobs
- ‚úÖ **Persistance** automatique avec Mongoose
- ‚úÖ **Performance** tracking temps d'ex√©cution, erreurs, succ√®s
- ‚úÖ **√âvolutivit√©** facile ajout de nouveaux managers/services
- ‚úÖ **Maintenance** code organis√© et modulaire

**üí° Cette architecture r√©sout la confusion entre les concepts BullMQ en fournissant une structure logique et √©volutive. Chaque composant a sa responsabilit√© d√©finie !**
